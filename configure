#!/bin/bash
# configure - GNU autoconf-style configuration script for Pickleball Video Editor
# Checks dependencies, creates virtual environment, and generates config.mk

set -e

# -----------------------------------------------------------------------------
# Terminal Colors
# -----------------------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
RESET='\033[0m'

info() {
    echo -e "${BLUE}==>${RESET} ${BOLD}$1${RESET}"
}

success() {
    echo -e "${GREEN}✓${RESET} $1"
}

warning() {
    echo -e "${YELLOW}⚠${RESET} $1"
}

error() {
    echo -e "${RED}✗ Error:${RESET} $1" >&2
}

fatal() {
    error "$1"
    exit 1
}

# -----------------------------------------------------------------------------
# Default Configuration
# -----------------------------------------------------------------------------
PREFIX="/usr/local"
PYTHON_CMD="python3.13"
USE_VENV="yes"
ENABLE_DEV="no"
VENV_DIR=".venv"
APP_NAME="pickleball-editor"
APP_VERSION="0.1.0"

# -----------------------------------------------------------------------------
# Help Message
# -----------------------------------------------------------------------------
show_help() {
    echo -e "${BOLD}Pickleball Video Editor Configuration Script${RESET}"
    cat << EOF

Usage: ./configure [OPTIONS]

Options:
  --help                  Show this help message and exit
  --prefix=DIR            Install prefix (default: /usr/local)
  --python=CMD            Python command to use (default: python3.13)
  --with-venv=DIR         Use virtual environment at DIR (default: .venv)
  --disable-venv          Do not create/use a virtual environment
  --enable-dev            Install development dependencies (pytest, ruff, mypy)

Examples:
  ./configure
  ./configure --prefix=/opt/pickleball-editor
  ./configure --python=python3.13 --enable-dev
  ./configure --disable-venv --prefix=\$HOME/.local

This script will:
  1. Check for Python 3.13+
  2. Check for required system dependencies (libmpv, ffmpeg, ffprobe, Qt6)
  3. Create a virtual environment (unless --disable-venv)
  4. Install Python dependencies (PyQt6, python-mpv, lxml, PyInstaller)
  5. Generate config.mk with build configuration

EOF
}

# -----------------------------------------------------------------------------
# Parse Command Line Arguments
# -----------------------------------------------------------------------------
for arg in "$@"; do
    case $arg in
        --help)
            show_help
            exit 0
            ;;
        --prefix=*)
            PREFIX="${arg#*=}"
            ;;
        --python=*)
            PYTHON_CMD="${arg#*=}"
            ;;
        --with-venv=*)
            VENV_DIR="${arg#*=}"
            USE_VENV="yes"
            ;;
        --disable-venv)
            USE_VENV="no"
            ;;
        --enable-dev)
            ENABLE_DEV="yes"
            ;;
        *)
            error "Unknown option: $arg"
            echo "Run './configure --help' for usage information."
            exit 1
            ;;
    esac
done

# -----------------------------------------------------------------------------
# Version Comparison Helper
# -----------------------------------------------------------------------------
version_gte() {
    # Returns 0 (success) if $1 >= $2
    printf '%s\n%s\n' "$2" "$1" | sort -V -C
}

# -----------------------------------------------------------------------------
# Dependency Checks
# -----------------------------------------------------------------------------
info "Checking system dependencies..."

# Check Python version
if ! command -v "$PYTHON_CMD" &> /dev/null; then
    fatal "Python command '$PYTHON_CMD' not found. Use --python=CMD to specify a different Python."
fi

PYTHON_VERSION=$("$PYTHON_CMD" --version 2>&1 | awk '{print $2}')
if ! version_gte "$PYTHON_VERSION" "3.13.0"; then
    fatal "Python 3.13+ required, found $PYTHON_VERSION"
fi
success "Python $PYTHON_VERSION found"

# Get absolute path to Python
PYTHON_PATH=$(command -v "$PYTHON_CMD")

# Check pip
if ! "$PYTHON_CMD" -m pip --version &> /dev/null; then
    fatal "pip not found for $PYTHON_CMD. Please install python3-pip."
fi
success "pip found"

# Check libmpv
if ! pkg-config --exists mpv; then
    warning "libmpv not found via pkg-config. Video playback may not work."
    warning "Install with: sudo pacman -S mpv (Arch/Manjaro)"
    MPV_VERSION="unknown"
else
    MPV_VERSION=$(pkg-config --modversion mpv)
    if ! version_gte "$MPV_VERSION" "0.35.0"; then
        warning "libmpv $MPV_VERSION found, but 0.35+ recommended"
    else
        success "libmpv $MPV_VERSION found"
    fi
fi

# Check ffmpeg
if ! command -v ffmpeg &> /dev/null; then
    warning "ffmpeg not found. Video processing may not work."
    warning "Install with: sudo pacman -S ffmpeg (Arch/Manjaro)"
    FFMPEG_VERSION="not found"
else
    FFMPEG_VERSION=$(ffmpeg -version | head -n1 | awk '{print $3}')
    success "ffmpeg $FFMPEG_VERSION found"
fi

# Check ffprobe
if ! command -v ffprobe &> /dev/null; then
    warning "ffprobe not found. Video metadata extraction may not work."
    FFPROBE_VERSION="not found"
else
    FFPROBE_VERSION=$(ffprobe -version | head -n1 | awk '{print $3}')
    success "ffprobe $FFPROBE_VERSION found"
fi

# Check Qt6
if ! pkg-config --exists Qt6Core; then
    warning "Qt6 not found via pkg-config. PyQt6 may have issues."
    warning "Install with: sudo pacman -S qt6-base (Arch/Manjaro)"
    QT6_VERSION="unknown"
else
    QT6_VERSION=$(pkg-config --modversion Qt6Core)
    success "Qt6 $QT6_VERSION found"
fi

# -----------------------------------------------------------------------------
# Virtual Environment Setup
# -----------------------------------------------------------------------------
if [ "$USE_VENV" = "yes" ]; then
    info "Setting up virtual environment at $VENV_DIR..."

    if [ -d "$VENV_DIR" ]; then
        warning "Virtual environment already exists at $VENV_DIR, using existing one"
    else
        "$PYTHON_CMD" -m venv "$VENV_DIR" || fatal "Failed to create virtual environment"
        success "Virtual environment created"
    fi

    # Determine activation script path
    VENV_ACTIVATE="$VENV_DIR/bin/activate"
    VENV_PYTHON="$VENV_DIR/bin/python"
    VENV_PIP="$VENV_DIR/bin/pip"

    if [ ! -f "$VENV_ACTIVATE" ]; then
        fatal "Virtual environment activation script not found at $VENV_ACTIVATE"
    fi
else
    info "Virtual environment disabled, using system Python"
    VENV_PYTHON="$PYTHON_PATH"
    VENV_PIP="$PYTHON_CMD -m pip"
fi

# -----------------------------------------------------------------------------
# Python Dependencies Installation
# -----------------------------------------------------------------------------
info "Installing Python dependencies..."

PIP_INSTALL_CMD="$VENV_PIP install --upgrade"

# Core dependencies
CORE_DEPS=(
    "PyQt6>=6.6.0"
    "python-mpv>=1.0.0"
    "lxml>=5.0.0"
    "PyInstaller>=6.0.0"
)

# Development dependencies
DEV_DEPS=(
    "pytest>=7.4.0"
    "pytest-qt>=4.2.0"
    "ruff>=0.1.0"
    "mypy>=1.7.0"
    "black>=23.0.0"
)

echo "Installing core dependencies..."
for dep in "${CORE_DEPS[@]}"; do
    echo "  - $dep"
done

$PIP_INSTALL_CMD "${CORE_DEPS[@]}" || fatal "Failed to install core dependencies"
success "Core dependencies installed"

if [ "$ENABLE_DEV" = "yes" ]; then
    echo "Installing development dependencies..."
    for dep in "${DEV_DEPS[@]}"; do
        echo "  - $dep"
    done

    $PIP_INSTALL_CMD "${DEV_DEPS[@]}" || fatal "Failed to install development dependencies"
    success "Development dependencies installed"
fi

# -----------------------------------------------------------------------------
# Generate config.mk
# -----------------------------------------------------------------------------
info "Generating config.mk..."

CONFIG_MK="config.mk"

cat > "$CONFIG_MK" << EOF
# config.mk - Generated by configure on $(date)
# Do not edit manually - re-run ./configure to regenerate

# Application metadata
APP_NAME = $APP_NAME
APP_VERSION = $APP_VERSION

# Installation paths
PREFIX = $PREFIX
BINDIR = \$(PREFIX)/bin
DATADIR = \$(PREFIX)/share
DESKTOPDIR = \$(DATADIR)/applications

# Python configuration
PYTHON = $VENV_PYTHON
PYTHON_VERSION = $PYTHON_VERSION
USE_VENV = $USE_VENV
VENV_DIR = $VENV_DIR

# System dependencies
MPV_VERSION = $MPV_VERSION
FFMPEG_VERSION = $FFMPEG_VERSION
FFPROBE_VERSION = $FFPROBE_VERSION
QT6_VERSION = $QT6_VERSION

# Build configuration
ENABLE_DEV = $ENABLE_DEV
PYINSTALLER = $([ "$USE_VENV" = "yes" ] && echo "$VENV_DIR/bin/pyinstaller" || echo "pyinstaller")

# Source paths
SRC_DIR = src
TESTS_DIR = tests
RESOURCES_DIR = resources

# Build output
BUILD_DIR = build
DIST_DIR = dist
SPEC_FILE = $APP_NAME.spec

# Test configuration
PYTEST = $([ "$USE_VENV" = "yes" ] && echo "$VENV_DIR/bin/pytest" || echo "pytest")
RUFF = $([ "$USE_VENV" = "yes" ] && echo "$VENV_DIR/bin/ruff" || echo "ruff")
MYPY = $([ "$USE_VENV" = "yes" ] && echo "$VENV_DIR/bin/mypy" || echo "mypy")
BLACK = $([ "$USE_VENV" = "yes" ] && echo "$VENV_DIR/bin/black" || echo "black")
EOF

success "config.mk generated"

# -----------------------------------------------------------------------------
# Summary
# -----------------------------------------------------------------------------
echo ""
info "Configuration complete!"
echo ""
echo -e "${BOLD}Configuration Summary:${RESET}"
echo "  Prefix:            $PREFIX"
echo "  Python:            $PYTHON_VERSION ($PYTHON_PATH)"
echo "  Virtual env:       $([ "$USE_VENV" = "yes" ] && echo "$VENV_DIR" || echo "disabled")"
echo "  Development mode:  $([ "$ENABLE_DEV" = "yes" ] && echo "enabled" || echo "disabled")"
echo ""
echo -e "${BOLD}System Dependencies:${RESET}"
echo "  libmpv:            $MPV_VERSION"
echo "  ffmpeg:            $FFMPEG_VERSION"
echo "  ffprobe:           $FFPROBE_VERSION"
echo "  Qt6:               $QT6_VERSION"
echo ""
echo -e "${BOLD}Next Steps:${RESET}"
echo -e "  1. Build the application:  ${GREEN}make${RESET}"
echo -e "  2. Run tests:              ${GREEN}make test${RESET}"
echo -e "  3. Install system-wide:    ${GREEN}sudo make install${RESET}"
echo -e "  4. Run in dev mode:        ${GREEN}make run${RESET}"
echo ""
echo -e "See ${BOLD}make help${RESET} for all available targets."
